<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
<HEAD>
<TITLE>Page 174</TITLE>

<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<BODY bgcolor="#FFFFFF" vlink="blue" link="blue" >
<p style="position:absolute;top:0px;left:0px"><img src="images/azure-cognitive-services-openai0174.png" width="892px" height="1252px">
</img></p>
<p style="position:absolute;top:125px;left:96px"><span style="virtical-align:top;font-size:16px;font-family:AAAAAC+SegoeUI;color:#161616;w_h699w_h24w_h;letter-spacing:0.35413px;">Next&nbsp;we&nbsp;create&nbsp;the&nbsp;OpenAICompletion&nbsp;object.&nbsp;Rather&nbsp;than&nbsp;setting&nbsp;the&nbsp;prompt&nbsp;column,&nbsp;set</span></p>
<p style="position:absolute;top:156px;left:96px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h518w_h24w_h;letter-spacing:0.45824px;">the&nbsp;batchPrompt&nbsp;column&nbsp;if&nbsp;your&nbsp;column&nbsp;is&nbsp;of&nbsp;type&nbsp;Array[String].</span></p>
<p style="position:absolute;top:211px;left:115px"><span style="virtical-align:top;font-size:12px;font-family:AAAAAC+SegoeUI;color:#161616;w_h45w_h19w_h;letter-spacing:1.19594px;">Python</span></p>
<p style="position:absolute;top:512px;left:96px"><span style="virtical-align:top;font-size:16px;font-family:AAAAAC+SegoeUI;color:#161616;w_h694w_h24w_h;letter-spacing:0.31189px;">In&nbsp;the&nbsp;call&nbsp;to&nbsp;transform,&nbsp;a&nbsp;request&nbsp;will&nbsp;then&nbsp;be&nbsp;made&nbsp;per&nbsp;row.&nbsp;Because&nbsp;there&nbsp;are&nbsp;multiple</span></p>
<p style="position:absolute;top:541px;left:96px"><span style="virtical-align:top;font-size:16px;font-family:AAAAAC+SegoeUI;color:#161616;w_h654w_h24w_h;letter-spacing:0.30266px;">prompts&nbsp;in&nbsp;a&nbsp;single&nbsp;row,&nbsp;each&nbsp;request&nbsp;will&nbsp;be&nbsp;sent&nbsp;with&nbsp;all&nbsp;prompts&nbsp;in&nbsp;that&nbsp;row.&nbsp;The</span></p>
<p style="position:absolute;top:569px;left:96px"><span style="virtical-align:top;font-size:16px;font-family:AAAAAC+SegoeUI;color:#161616;w_h418w_h24w_h;letter-spacing:0.30429px;">results&nbsp;will&nbsp;contain&nbsp;a&nbsp;row&nbsp;for&nbsp;each&nbsp;row&nbsp;in&nbsp;the&nbsp;request.</span></p>
<p style="position:absolute;top:623px;left:115px"><span style="virtical-align:top;font-size:12px;font-family:AAAAAC+SegoeUI;color:#161616;w_h45w_h19w_h;letter-spacing:1.19594px;">Python</span></p>
<p style="position:absolute;top:983px;left:96px"><span style="virtical-align:top;font-size:16px;font-family:AAAAAC+SegoeUI;color:#161616;w_h687w_h24w_h;letter-spacing:0.32391px;">If&nbsp;your&nbsp;data&nbsp;is&nbsp;in&nbsp;column&nbsp;format,&nbsp;you&nbsp;can&nbsp;transpose&nbsp;it&nbsp;to&nbsp;row&nbsp;format&nbsp;using&nbsp;SynapseML's</span></p>
<p style="position:absolute;top:1018px;left:98px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h227w_h18w_h;letter-spacing:0.85172px;">FixedMiniBatcherTransformer</span></p>
<p style="position:absolute;top:1013px;left:328px"><span style="virtical-align:top;font-size:16px;font-family:AAAAAC+SegoeUI;color:#161616;w_h4w_h24w_h;letter-spacing:0.00000px;">.</span></p>
<p style="position:absolute;top:1068px;left:115px"><span style="virtical-align:top;font-size:12px;font-family:AAAAAC+SegoeUI;color:#161616;w_h45w_h19w_h;letter-spacing:1.19594px;">Python</span></p>
<p style="position:absolute;top:42px;left:151px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h9w_h18w_h;letter-spacing:0.00000px;">]</span></p>
<p style="position:absolute;top:64px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#a31515;w_h182w_h18w_h;letter-spacing:0.58784px;">).toDF(&quot;batchPrompt&quot;)</span></p>
<p style="position:absolute;top:258px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h173w_h18w_h;letter-spacing:0.57987px;">batch_completion&nbsp;=&nbsp;(</span></p>
<p style="position:absolute;top:280px;left:151px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h156w_h18w_h;letter-spacing:0.00000px;">OpenAICompletion()</span></p>
<p style="position:absolute;top:301px;left:151px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h208w_h18w_h;letter-spacing:0.00000px;">.setSubscriptionKey(key)</span></p>
<p style="position:absolute;top:322px;left:151px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h303w_h18w_h;letter-spacing:0.00000px;">.setDeploymentName(deployment_name)</span></p>
<p style="position:absolute;top:344px;left:151px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#a31515;w_h528w_h18w_h;letter-spacing:0.71767px;">.setUrl(&quot;https://{}.openai.azure.com/&quot;.format(resource_name))</span></p>
<p style="position:absolute;top:365px;left:151px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h156w_h18w_h;letter-spacing:0.91318px;">.setMaxTokens(200)</span></p>
<p style="position:absolute;top:386px;left:151px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#a31515;w_h286w_h18w_h;letter-spacing:0.65340px;">.setBatchPromptCol(&quot;batchPrompt&quot;)</span></p>
<p style="position:absolute;top:408px;left:151px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#a31515;w_h182w_h18w_h;letter-spacing:0.58781px;">.setErrorCol(&quot;error&quot;)</span></p>
<p style="position:absolute;top:429px;left:151px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#a31515;w_h242w_h18w_h;letter-spacing:0.63140px;">.setOutputCol(&quot;completions&quot;)</span></p>
<p style="position:absolute;top:451px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h9w_h18w_h;letter-spacing:0.00000px;">)</span></p>
<p style="position:absolute;top:670px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h563w_h18w_h;letter-spacing:0.72285px;">completed_batch_df&nbsp;=&nbsp;batch_completion.transform(batch_df).cache()</span></p>
<p style="position:absolute;top:691px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h234w_h18w_h;letter-spacing:0.00000px;">display(completed_batch_df)</span></p>
<p style="position:absolute;top:775px;left:115px"><span style="virtical-align:top;font-size:16px;font-family:DAAAAA+docons;color:#3b2e58;w_h18w_h20w_h;letter-spacing:0.00000px;">ï¼—</span></p>
<p style="position:absolute;top:772px;left:138px"><span style="virtical-align:top;font-size:16px;font-family:AAAAAB+SegoeUI-Semibold;color:#3b2e58;font-weight:bold;w_h41w_h24w_h;letter-spacing:1.51941px;">Note</span></p>
<p style="position:absolute;top:818px;left:115px"><span style="virtical-align:top;font-size:16px;font-family:AAAAAC+SegoeUI;color:#161616;w_h611w_h24w_h;letter-spacing:0.28987px;">There&nbsp;is&nbsp;currently&nbsp;a&nbsp;limit&nbsp;of&nbsp;20&nbsp;prompts&nbsp;in&nbsp;a&nbsp;single&nbsp;request&nbsp;and&nbsp;a&nbsp;limit&nbsp;of&nbsp;2048</span></p>
<p style="position:absolute;top:847px;left:115px"><span style="virtical-align:top;font-size:16px;font-family:AAAAAC+SegoeUI;color:#161616;w_h311w_h24w_h;letter-spacing:0.35356px;">&quot;tokens&quot;,&nbsp;or&nbsp;approximately&nbsp;1500&nbsp;words.</span></p>
<p style="position:absolute;top:927px;left:96px"><span style="virtical-align:top;font-size:24px;font-family:AAAAAB+SegoeUI-Semibold;color:#161616;font-weight:bold;w_h398w_h36w_h;letter-spacing:0.45207px;">Using&nbsp;an&nbsp;automatic&nbsp;mini-batcher</span></p>
<p style="position:absolute;top:1115px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#0101fd;w_h346w_h18w_h;letter-spacing:0.61263px;">from&nbsp;pyspark.sql.types&nbsp;import&nbsp;StringType</span></p>
<p style="position:absolute;top:1137px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#0101fd;w_h476w_h18w_h;letter-spacing:0.65657px;">from&nbsp;synapse.ml.stages&nbsp;import&nbsp;FixedMiniBatchTransformer</span></p>
<p style="position:absolute;top:1158px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#0101fd;w_h372w_h18w_h;letter-spacing:0.62331px;">from&nbsp;synapse.ml.core.spark&nbsp;import&nbsp;FluentAPI</span></p>
<p style="position:absolute;top:1201px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h242w_h18w_h;letter-spacing:0.63142px;">completed_autobatch_df&nbsp;=&nbsp;(df</span></p>
</BODY>
</HTML>
