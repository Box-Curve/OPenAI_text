<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
<HEAD>
<TITLE>Page 204</TITLE>

<META http-equiv="Content-Type" content="text/html; charset=UTF-8">
</HEAD>
<BODY bgcolor="#FFFFFF" vlink="blue" link="blue" >
<p style="position:absolute;top:0px;left:0px"><img src="images/azure-cognitive-services-openai0204.png" width="892px" height="1252px">
</img></p>
<p style="position:absolute;top:50px;left:115px"><span style="virtical-align:top;font-size:12px;font-family:AAAAAC+SegoeUI;color:#161616;w_h45w_h19w_h;letter-spacing:0.95675px;">Python</span></p>
<p style="position:absolute;top:479px;left:96px"><span style="virtical-align:top;font-size:16px;font-family:AAAAAC+SegoeUI;color:#161616;w_h667w_h24w_h;letter-spacing:0.30897px;">Now&nbsp;we&nbsp;need&nbsp;to&nbsp;remove&nbsp;any&nbsp;bills&nbsp;that&nbsp;are&nbsp;too&nbsp;long&nbsp;for&nbsp;the&nbsp;token&nbsp;limit&nbsp;(8192&nbsp;tokens).</span></p>
<p style="position:absolute;top:532px;left:115px"><span style="virtical-align:top;font-size:12px;font-family:AAAAAC+SegoeUI;color:#161616;w_h45w_h19w_h;letter-spacing:1.19594px;">Python</span></p>
<p style="position:absolute;top:732px;left:115px"><span style="virtical-align:top;font-size:12px;font-family:AAAAAC+SegoeUI;color:#161616;w_h45w_h19w_h;letter-spacing:1.21553px;">Output</span></p>
<p style="position:absolute;top:1059px;left:96px"><span style="virtical-align:top;font-size:16px;font-family:AAAAAB+SegoeUI-Semibold;color:#161616;font-weight:bold;w_h267w_h24w_h;letter-spacing:0.38575px;">We'll&nbsp;once&nbsp;again&nbsp;examine&nbsp;df_bills.</span></p>
<p style="position:absolute;top:1112px;left:115px"><span style="virtical-align:top;font-size:12px;font-family:AAAAAC+SegoeUI;color:#161616;w_h45w_h19w_h;letter-spacing:1.19594px;">Python</span></p>
<p style="position:absolute;top:97px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#07704a;w_h658w_h18w_h;letter-spacing:0.69322px;">pd.options.mode.chained_assignment&nbsp;=&nbsp;None&nbsp;#https://pandas.pydata.org/pandas-</span></p>
<p style="position:absolute;top:119px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#008000;w_h528w_h18w_h;letter-spacing:0.00000px;">docs/stable/user_guide/indexing.html#evaluation-order-matters</span></p>
<p style="position:absolute;top:161px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#008000;w_h147w_h18w_h;letter-spacing:0.39431px;">#&nbsp;s&nbsp;is&nbsp;input&nbsp;text</span></p>
<p style="position:absolute;top:183px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h364w_h18w_h;letter-spacing:0.42613px;">def&nbsp;normalize_text(s,&nbsp;sep_token&nbsp;=&nbsp;&quot;&nbsp;\n&nbsp;&quot;):</span></p>
<p style="position:absolute;top:204px;left:151px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h303w_h18w_h;letter-spacing:0.49840px;">s&nbsp;=&nbsp;re.sub(r'\s+',&nbsp;'&nbsp;',&nbsp;s).strip()</span></p>
<p style="position:absolute;top:226px;left:151px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#a31515;w_h199w_h18w_h;letter-spacing:0.33337px;">s&nbsp;=&nbsp;re.sub(r&quot;.&nbsp;,&quot;,&quot;&quot;,s)</span></p>
<p style="position:absolute;top:247px;left:151px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#008000;w_h355w_h18w_h;letter-spacing:0.48239px;">#&nbsp;remove&nbsp;all&nbsp;instances&nbsp;of&nbsp;multiple&nbsp;spaces</span></p>
<p style="position:absolute;top:268px;left:151px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#a31515;w_h199w_h18w_h;letter-spacing:0.36604px;">s&nbsp;=&nbsp;s.replace(&quot;..&quot;,&quot;.&quot;)</span></p>
<p style="position:absolute;top:290px;left:151px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#a31515;w_h208w_h18w_h;letter-spacing:0.34177px;">s&nbsp;=&nbsp;s.replace(&quot;.&nbsp;.&quot;,&quot;.&quot;)</span></p>
<p style="position:absolute;top:311px;left:151px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#a31515;w_h199w_h18w_h;letter-spacing:0.33339px;">s&nbsp;=&nbsp;s.replace(&quot;\n&quot;,&nbsp;&quot;&quot;)</span></p>
<p style="position:absolute;top:332px;left:151px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h113w_h18w_h;letter-spacing:0.50256px;">s&nbsp;=&nbsp;s.strip()</span></p>
<p style="position:absolute;top:375px;left:151px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#0101fd;w_h69w_h18w_h;letter-spacing:0.59030px;">return&nbsp;s</span></p>
<p style="position:absolute;top:418px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h606w_h18w_h;letter-spacing:0.57982px;">df_bills['text']=&nbsp;df_bills[&quot;text&quot;].apply(lambda&nbsp;x&nbsp;:&nbsp;normalize_text(x))</span></p>
<p style="position:absolute;top:579px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#a31515;w_h416w_h18w_h;letter-spacing:0.59041px;">tokenizer&nbsp;=&nbsp;tiktoken.get_encoding(&quot;cl100k_base&quot;)</span></p>
<p style="position:absolute;top:600px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#0101fd;w_h476w_h18w_h;letter-spacing:0.57239px;">df_bills['n_tokens']&nbsp;=&nbsp;df_bills[&quot;text&quot;].apply(lambda&nbsp;x:</span></p>
<p style="position:absolute;top:622px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h216w_h18w_h;letter-spacing:0.00000px;">len(tokenizer.encode(x)))</span></p>
<p style="position:absolute;top:643px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h372w_h18w_h;letter-spacing:0.64641px;">df_bills&nbsp;=&nbsp;df_bills[df_bills.n_tokens&lt;8192]</span></p>
<p style="position:absolute;top:664px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h113w_h18w_h;letter-spacing:0.00000px;">len(df_bills)</span></p>
<p style="position:absolute;top:779px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h17w_h18w_h;letter-spacing:0.00000px;">20</span></p>
<p style="position:absolute;top:863px;left:115px"><span style="virtical-align:top;font-size:16px;font-family:CAAAAA+docons;color:#3b2e58;w_h18w_h20w_h;letter-spacing:0.00000px;">ï¼—</span></p>
<p style="position:absolute;top:860px;left:138px"><span style="virtical-align:top;font-size:16px;font-family:AAAAAB+SegoeUI-Semibold;color:#3b2e58;font-weight:bold;w_h41w_h24w_h;letter-spacing:1.51941px;">Note</span></p>
<p style="position:absolute;top:907px;left:115px"><span style="virtical-align:top;font-size:16px;font-family:AAAAAC+SegoeUI;color:#161616;w_h649w_h24w_h;letter-spacing:0.31199px;">In&nbsp;this&nbsp;case&nbsp;all&nbsp;bills&nbsp;are&nbsp;under&nbsp;the&nbsp;embedding&nbsp;model&nbsp;input&nbsp;token&nbsp;limit,&nbsp;but&nbsp;you&nbsp;can</span></p>
<p style="position:absolute;top:935px;left:115px"><span style="virtical-align:top;font-size:16px;font-family:AAAAAC+SegoeUI;color:#161616;w_h657w_h24w_h;letter-spacing:0.37624px;">use&nbsp;the&nbsp;technique&nbsp;above&nbsp;to&nbsp;remove&nbsp;entries&nbsp;that&nbsp;would&nbsp;otherwise&nbsp;cause&nbsp;embedding</span></p>
<p style="position:absolute;top:964px;left:115px"><span style="virtical-align:top;font-size:16px;font-family:AAAAAC+SegoeUI;color:#161616;w_h631w_h24w_h;letter-spacing:0.33344px;">to&nbsp;fail.&nbsp;When&nbsp;faced&nbsp;with&nbsp;content&nbsp;that&nbsp;exceeds&nbsp;the&nbsp;embedding&nbsp;limit,&nbsp;you&nbsp;can&nbsp;also</span></p>
<p style="position:absolute;top:993px;left:115px"><span style="virtical-align:top;font-size:16px;font-family:AAAAAC+SegoeUI;color:#161616;w_h595w_h24w_h;letter-spacing:0.32820px;">chunk&nbsp;the&nbsp;content&nbsp;into&nbsp;smaller&nbsp;pieces&nbsp;and&nbsp;then&nbsp;embed&nbsp;those&nbsp;one&nbsp;at&nbsp;a&nbsp;time.</span></p>
<p style="position:absolute;top:1159px;left:116px"><span style="virtical-align:top;font-size:13px;font-family:AAAAAE+Consolas;color:#161616;w_h69w_h18w_h;letter-spacing:0.00000px;">df_bills</span></p>
</BODY>
</HTML>
